$(function(){function e(){function e(e){return{init:function(o,t,i,a,n){var r,s;r=function(o,i){i.keyCode===e&&t().call(this,o,i)},s=function(){return{keyup:r}},ko.bindingHandlers.event.init(o,s,i,a,n)}}}function o(e){gMaps.call(this,e),this.name=ko.observable(e.name),this.city=ko.observable(e.city),this.mapcenter=ko.observable(e.mapcenter),this.selected=ko.observable(e.selected),this.nearByPlaces=ko.observableArray([]),this.savePlaces=[],this.markers=[],this.marker=null,this.self=r}function t(e,o){return e.slice(0,o.length)==o}function i(e){var o=r.placePhotos().length,t=r.currentIndex(),i=(t+e)%o;0>i&&(i=o-1),r.currentPhoto(r.placePhotos()[i]),r.currentIndex(i)}function a(){var e=$(window).width();e>800?r.showResults(!0):r.showResults(!1)}var n=13;ko.bindingHandlers.enterKey=e(n);var r=this;r.myLocations=ko.observableArray([]),r.showLocation=ko.observable(!1),r.showCategory=ko.observable(!1),r.showResults=ko.observable(!0),r.numberPlaces=ko.observable(0),r.placeReviews=ko.observableArray([]),r.placePhotos=ko.observableArray([]),r.placeInFocus=ko.observable(),r.nytarticles=ko.observableArray([]),r.nytInFocus=ko.observable(),r.wikiarticles=ko.observableArray([]),r.wikiInFocus=ko.observable(),r.streetView=ko.observable(),r.noimage=ko.observable(),r.showView=ko.observable(!1),r.currentPhoto=ko.observable(),r.currentIndex=ko.observable(0),r.keyword=ko.observable(),r.mapPlaceTypes=ko.observableArray(mapPlaceTypes),r.myCategories=ko.observableArray(myCategories),inherit(o,gMaps),r.initLocations=function(e){r.myLocations([]),r.numberPlaces(0),e.forEach(function(e){var t=new o(e);r.myLocations().push(t),t.markLocation(),t.selected()||t.marker.setMap(null)})},r.initLocations(myLocations);var s,c,l;try{s=new gMaps,l=s.infoWindow,c=s.marker_animation,s.initAutocomplete(),s.self=r}catch(u){alert.render("failed to load Google maps, check your network")}var y="http://api.nytimes.com/svc/search/v2/articlesearch.json?",m="befcd9ed183aa5edba4a379ed537e27f:10:73683129",d="http://en.wikipedia.org/w/api.php?action=opensearch&search=%data%&format=json&callback=wikiCallback",f="http://maps.googleapis.com/maps/api/streetview?";r.displayLocation=function(e){e.selected()&&e.nearbySearch()},r.hideLocation=function(){r.showLocation(!1)},r.toggleLocation=function(){0==r.myLocations().length?r.showLocation(!1):r.showLocation(!r.showLocation()),r.showCategory(!1)},r.toggleCategory=function(){r.showCategory(!r.showCategory()),r.showLocation(!1)},r.filteredLocations=ko.computed(function(){return r.myLocations()},s),r.selectLocation=function(e){e.selected(!e.selected()),r.showLocation(!1),e.selected()?e.markLocation():(r.numberPlaces(r.numberPlaces()-e.nearByPlaces().length),e.nearByPlaces([]),e.marker&&e.marker.setMap(null),r.setCenter()),e.createMarkers(e.nearByPlaces()),0==r.numberPlaces()&&(r.numberPlaces(0),r.showResults(!1))},r.myCity=ko.computed(function(){var e=r.myLocations().filter(function(e){return e.selected()});return e.length>0?e[0].city():""}),r.closeWiki=function(){r.wikiarticles([])},r.closeNyt=function(){r.nytarticles([])},r.closeReview=function(){r.placeReviews([])},r.closePhoto=function(){r.placePhotos([]),r.currentIndex(0)},r.photoIndex=ko.pureComputed(function(){return r.currentIndex()+1}),r.getPlace=function(){var e=r.keyword().trim();if(":"!=e.substring(0,1)){myCategories=[];var o=e.split(" ");r.getPlaces(o),r.showLocation(!1),r.showCategory(!1)}},r.getPlaces=function(e){e.forEach(function(e){function o(o){return t(o,e)}"clini"==e.substring(0,5)&&(e="hospital"),"fitness"==e&&(e="gym"),"eat"==e.substring(0,3)&&(e="food"),"metro"==e.substring(0,5)&&(e="subway"),mapplacetype=mapPlaceTypes.filter(o),mapplacetype.forEach(function(e){myCategories.push(e)}),r.myCategories(myCategories)}),r.numberPlaces(0),localStorage.myCategories=JSON.stringify(myCategories),r.setCenter()},r.getCategories=function(){console.log(r.myCategories())},r.addLocation=function(e){myLocations.unshift(e);var t=new o(e);r.myLocations.unshift(t),t.markLocation(),localStorage.myLocations=JSON.stringify(myLocations)},r.removeLocation=function(e){var o=e.name;e.selected()&&r.selectLocation(e);try{localStorage.myLocations=ko.toJS(r.myLocations())}catch(t){console.log(t),r.myLocations(r.myLocations().filter(function(e,t){return myLocations[t].remove=!0,e.name!=o?(myLocations[t].remove=!1,e):void 0})),myLocations=myLocations.filter(function(e){return 0==e.remove?e:void 0}),localStorage.myLocations=JSON.stringify(myLocations)}},r.setCenter=function(){var e=r.myLocations().filter(function(e){return e.selected()});e.length>0&&e[0].setCenter()},r.getAddress=function(e){if(e.vicinity){var o=e.vicinity.indexOf(",");return e.vicinity.slice(0,o)}return e.formatted_address},r.getLocality=function(e){var o=e.adr_address,t='class="locality">',i='class="country-name">',a='class="region">',n=0,r={},s=0;return idx1=o.indexOf(t),idx1>0&&(n=idx1+t.length,s=o.indexOf("</span>",n),r.locality=o.slice(n,s)),idx1=o.indexOf('class="region"',s+7),idx1>0&&(n=idx1+a.length,s=o.indexOf("</span>",n),r.region=o.slice(n,s)),idx1=o.indexOf('class="country-name"',s+7),idx1>0&&(n=idx1+i.length,s=o.indexOf("</span>",n),r.country=o.slice(n,s)),r},r.toggleResults=function(){r.numberPlaces()>0&&r.showResults(!r.showResults())},r.icons=ko.computed(function(){var e=new Set,o=[];return r.myLocations().forEach(function(o){for(var t in o.nearByPlaces())t&&e.add(o.nearByPlaces()[t].icon)}),e.forEach(function(e){o.push({icon:e})}),o.slice(0,8)}),r.rateStar=function(e){for(var o=Math.round(e),t=e-o,i=[],a=t>0?4-o:5-o,n=0;o>n;n++)i.push({star:"images/full-star.png"});for(t>0&&i.push({star:"images/half-star.png"}),n=0;a>n;n++)i.push({star:"images/empty-star.png"});return i},r.formattedType=function(e){var o=e.types[0].replace(/[_-]/g," ");return o.charAt(0).toUpperCase()+o.substr(1,o.length)},r.clickMarker=function(e){google.maps.event.trigger(e.marker,"click")},r.photoBackward=function(){i(-1)},r.photoForward=function(){i(1)},r.getNytArticle=function(e){r.nytarticles([]);var o=r.getLocality(e),t=y,i=o.locality+" ";o.region&&(i+=o.region);var a=o.country,n=[],s=$('script[data-template="nytimes"]').html();r.nytInFocus("about "+a+" "+i);var c=setTimeout(function(){n.push("<p>failed to query New York times resources</p>"),this.nytarticles(n)}.bind(r),5e3);$.getJSON(t,{q:i,fq:a,page:0,sort:"newest",hl:!0,"api-key":m}).done(function(e){"OK"==e.status&&$.each(e.response.docs,function(e,o){var t=o.headline.main;null!=t&&n.push(s.replace(/{{headline}}/,t).replace(/{{articleUrl}}/,o.web_url))}),this.nytarticles(n),clearTimeout(c)}.bind(r)).fail(function(e){n.push("<p>New York Times Articles could bot be loaded</p>"),this.nytarticles(n)}.bind(r))},r.openSearchWikipedia=function(e){r.wikiarticles([]);var o=r.getLocality(e),t=[],i=o.locality+" ";o.region&&(i+=o.region);var a=d.replace("%data%",i),n="http://fr.wikipedia.org/wiki/",s=$('script[data-template="wiki"]').html();r.wikiInFocus("about "+i);var c=setTimeout(function(){t.push("<p>failed to query wiki resources</p>"),this.wikiarticles(t)},5e3);$.ajax({url:a,dataType:"jsonp"}).done(function(e){var o=e[1];$.each(o,function(e,o){var i=n+o;t.push(s.replace(/{{wikiarticle}}/,o).replace(/{{articleUrl}}/,i))}),this.wikiarticles(t),clearTimeout(c)}.bind(r)).fail(function(e){t.push("<p>Wiki could bot be loaded</p>"),this.wikiarticles(t)}.bind(r))},r.getStreetView=function(e){r.streetView(f+"size=600x400&location="+e.formatted_address),r.noimage="Sorry no image for "+e.formatted_address,r.showView(!0)},r.closeView=function(){r.showView(!1)},$(window).resize(function(){a()}),$(document).ready(function(){$("#marker").toggle()}),r.myIcons=function(e){function o(e){var o=e.split("_")[0];return-1!=t.indexOf(o)?e:void 0}c=google.maps.Animation.DROP;var t=e.icon.split("/").slice(-1)[0].split("-").slice(0,1)[0];myCategories=mapPlaceTypes.filter(o),r.myCategories(myCategories),r.numberPlaces(0),r.showLocation(!1),r.showCategory(!1),localStorage.myCategories=JSON.stringify(myCategories)},r.resetIcons=function(){myCategories=[],r.myCategories(myCategories),r.numberPlaces(0),localStorage.myCategories=JSON.stringify(myCategories)},r.hideIcons=function(){}}localStorage.myLocations&&(myLocations=JSON.parse(localStorage.myLocations)),localStorage.myCategories&&(myCategories=JSON.parse(localStorage.myCategories));try{ko.applyBindings(new e)}catch(o){Alert.render("Error loading Knockout.js, check your network and retry")}$("#hide").click(function(){var e=$(this).children("span"),o=e.text();o="⊳⊳"==o?"⊲⊲":"⊳⊳",console.log(o),e.text(o),$(this).siblings("div").animate({width:"toggle"},500)})});